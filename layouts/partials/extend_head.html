<!-- ===== 引入字体 & Three.js ===== -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
(function () {
  /** 工具函数：标准化路径 => "/xxx/" */
  function normalizePath(path) {
    if (!path) return '/';
    return '/' + path.replace(/^\/+|\/+$/g, '') + '/';
  }

  /** ========== Three.js 背景初始化 ========== */
  function initThreejsBackground() {
    if (document.getElementById('threejs-container')) return;
    if (typeof THREE === 'undefined') {
      console.error('Three.js 未加载');
      return;
    }

    // 创建容器
    const container = document.createElement('div');
    container.id = 'threejs-container';
    container.style.cssText =
      'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;pointer-events:none;';
    document.body.appendChild(container);

    // 场景 & 相机 & 渲染器
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // 粒子系统
    const particlesCount = 200;
    const positions = new Float32Array(particlesCount * 3);
    for (let i = 0; i < positions.length; i++) {
      const base = (Math.random() - 0.5) * 20;
      positions[i] = base * (Math.abs(base) / 10);
    }
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

    const material = new THREE.PointsMaterial({
      size: 0.025,
      sizeAttenuation: true,
      color: 0x007acc,
      transparent: true,
      opacity: 0.8,
    });
    const particles = new THREE.Points(geometry, material);
    scene.add(particles);

    /** 主题联动 */
    function updateTheme(isDark) {
      if (isDark) {
        scene.background = new THREE.Color(0x121212);
        material.color.set(0x79c0ff);
        material.opacity = 0.9;
      } else {
        scene.background = new THREE.Color(0xffffff);
        material.color.set(0x007acc);
        material.opacity = 0.8;
      }
      material.needsUpdate = true;
    }
    updateTheme(document.body.classList.contains('dark'));

    // 监听 body class 变化（PaperMod 切换暗黑模式）
    new MutationObserver(() => updateTheme(document.body.classList.contains('dark')))
      .observe(document.body, { attributes: true, attributeFilter: ['class'] });

    // 动画
    function animate() {
      requestAnimationFrame(animate);
      particles.rotation.y += 0.0004;
      particles.rotation.x += 0.0002;
      particles.rotation.z += 0.0001;
      renderer.render(scene, camera);
    }
    animate();

    // 窗口缩放自适应
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  }

  /** ========== PJAX 页面切换 ========== */
  function initPjax() {
    document.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (!link || link.target === '_blank' || link.download) return;

      if (link.origin !== location.origin) return;
      if (link.hash && link.pathname === location.pathname) return;

      e.preventDefault();
      loadPage(link.href);
    });

    window.addEventListener('popstate', (e) => {
      if (e.state?.url) loadPage(e.state.url, false);
    });
  }

  function loadPage(url, addHistory = true) {
    fetch(url)
      .then((res) => res.text())
      .then((html) => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newContent = doc.querySelector('.main');
        if (!newContent) throw new Error('未找到 main 内容');

        document.querySelector('.main').replaceWith(newContent);
        document.title = doc.title;

        if (addHistory) history.pushState({ url }, doc.title, url);

        updateActiveNav();
      })
      .catch((err) => {
        console.error('PJAX 失败，回退到默认跳转', err);
        location.href = url;
      });
  }

  /** ========== 导航栏高亮 ========== */
  function updateActiveNav() {
    const currentPath = normalizePath(location.pathname);
    document.querySelectorAll('#menu li a span').forEach((span) => {
      span.classList.remove('active');
      const link = span.closest('a');
      if (!link) return;

      let linkPath = link.getAttribute('href') || '/';
      if (linkPath.startsWith('http')) {
        try {
          linkPath = new URL(linkPath).pathname;
        } catch {}
      }
      const normalizedLinkPath = normalizePath(linkPath);

      if (
        (normalizedLinkPath === '/index/' && currentPath === '/index/') ||
        (normalizedLinkPath !== '/index/' && currentPath.startsWith(normalizedLinkPath))
      ) {
        span.classList.add('active');
      }
    });
  }

  /** ========== 启动入口 ========== */
  window.addEventListener('DOMContentLoaded', () => {
    initThreejsBackground();
    initPjax();
    updateActiveNav();
  });
})();
</script>

<style>
/* Three.js 背景层 */
#threejs-container {
  z-index: -1 !important;
}

/* 页面主体内容浮在上面 */
body,
.main {
  background: transparent !important;
  position: relative;
  z-index: 1;
}
</style>
